#!/usr/bin/env bash

CONSUL_CONFIG_DIR="/etc/consul.d/"

## Remove pre-existing consul configuration
rm -rf /etc/consul.d/*
rm -rf /opt/consul/*

# Generate Certificates
echo -n "${CA_CERT}" > /etc/consul.d/consul-agent-ca.pem

# "Generate gossip encryption key"
echo encrypt = \"${GOSSIP_KEY}\" > $${CONSUL_CONFIG_DIR}agent-gossip-encryption.hcl

## Generate CLient configration file
tee $${CONSUL_CONFIG_DIR}agent-client-secure.hcl > /dev/null << EOF
## agent-client-secure.hcl

# 
server = false
datacenter = "${DATACENTER}"
domain = "${DOMAIN}" 

# Logging
log_level = "TRACE"

# Data persistence
data_dir = "/etc/consul/data"

#client_addr = "127.0.0.1"

# Join other Consul agents
${JOIN_STRING}

# retry_join = [ "$${SERVER_NAME}$${FQDN_SUFFIX}" ]

# Ports
ports {
  grpc  = 8502
  http  = 8500
  # https = 443
  https = -1
  dns   = 8600
}

# Enable Consul service mesh
connect {
  enabled = true
}

## Disable script checks
enable_script_checks = false

## Enable local script checks
enable_local_script_checks = true

# Enable central service config
enable_central_service_config = true


## TLS Encryption
tls {
  defaults {
    ca_file   = "/etc/consul/config/consul-agent-ca.pem"
    verify_outgoing        = true
    verify_incoming        = true
  }
  https {
    verify_incoming        = false
  }
  internal_rpc {
    verify_server_hostname = true
  }
}

auto_encrypt {
  tls = true
}

## ACL
acl {
  enabled        = true
  default_policy = "deny"
  enable_token_persistence = true
}
EOF

# tee $${CONSUL_CONFIG_DIR}agent-client-acl-tokens.hcl > /dev/null << EOF
# acl {
#   tokens {
#     agent  = "$${AGENT_TOKEN}"
#     default  = "$${DEFAULT_TOKEN}"
#   }
# }
# EOF
